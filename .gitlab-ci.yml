stages:
  - test
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  IMAGE_NAME: student-api
  REGISTRY_URL: registry.gitlab.com/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME

before_script:
  - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY

test:
  stage: test
  image: golang:1.21-alpine
  services:
    - name: postgres:13
      alias: postgres
  variables:
    POSTGRES_DB: testdb
    POSTGRES_USER: testuser
    POSTGRES_PASSWORD: testpass
    DB_HOST: postgres
    DB_PORT: 5432
  before_script:
    - apk add --no-cache git
    - go mod download
  script:
    - go test -v -race -coverprofile=coverage.out ./...
    - go tool cover -html=coverage.out -o coverage.html
  coverage: '/coverage: \d+\.\d+% of statements/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - coverage.html
    expire_in: 1 week

api_smoke_test:
  stage: test
  image: golang:1.21-alpine
  before_script:
    - apk add --no-cache git python3
    - go mod download
  script:
    - python3 scripts/api_smoke_test.py
  needs:
    - test

build:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  script:
    - docker build -t $REGISTRY_URL:$CI_COMMIT_SHA -t $REGISTRY_URL:latest -f deployments/kubernetes/Dockerfile .
    - docker push $REGISTRY_URL:$CI_COMMIT_SHA
    - docker push $REGISTRY_URL:latest
  only:
    - main
    - develop

deploy_staging:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - kubectl config use-context $KUBE_CONTEXT_STAGING
    - kubectl apply -f deployments/kubernetes/namespace.yaml
    - kubectl apply -f deployments/kubernetes/ -n student-api
    - kubectl set image deployment/student-api student-api=$REGISTRY_URL:$CI_COMMIT_SHA -n student-api
    - kubectl rollout status deployment/student-api -n student-api --timeout=300s
  environment:
    name: staging
    url: http://student-api.local
  only:
    - develop

deploy_production:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - kubectl config use-context $KUBE_CONTEXT_PROD
    - kubectl apply -f deployments/kubernetes/namespace.yaml
    - kubectl apply -f deployments/kubernetes/ -n student-api
    - kubectl set image deployment/student-api student-api=$REGISTRY_URL:$CI_COMMIT_SHA -n student-api
    - kubectl rollout status deployment/student-api -n student-api --timeout=300s
  environment:
    name: production
    url: https://student-api.yourdomain.com
  when: manual
  only:
    - main
